From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: violetc <58360096+s-yh-china@users.noreply.github.com>
Date: Mon, 3 Feb 2025 15:36:21 +0800
Subject: [PATCH] Return nether portal fix

This patch is powered by NetherPortalFix(https://github.com/TwelveIterationMods/NetherPortalFix)

diff --git a/net/minecraft/server/level/ServerPlayer.java b/net/minecraft/server/level/ServerPlayer.java
index d4df6ca7360d4bc605a51061444191d7929c7778..134f6eba6655b7294ebcdf5cf5d9e2183e2ecf5b 100644
--- a/net/minecraft/server/level/ServerPlayer.java
+++ b/net/minecraft/server/level/ServerPlayer.java
@@ -1576,6 +1576,21 @@ public class ServerPlayer extends Player implements ca.spottedleaf.moonrise.patc
                 org.bukkit.event.player.PlayerChangedWorldEvent changeEvent = new org.bukkit.event.player.PlayerChangedWorldEvent(this.getBukkitEntity(), serverLevel.getWorld());
                 this.level().getCraftServer().getPluginManager().callEvent(changeEvent);
                 // CraftBukkit end
+                // Leaves start - nether portal fix
+                if (org.leavesmc.leaves.LeavesConfig.modify.netherPortalFix) {
+                    final ResourceKey<Level> fromDim = serverLevel.dimension();
+                    final ResourceKey<Level> toDim = level().dimension();
+                    final ResourceKey<Level> OVERWORLD = Level.OVERWORLD;
+                    final ResourceKey<Level> THE_NETHER = Level.NETHER;
+                    if (!((fromDim != OVERWORLD || toDim != THE_NETHER) && (fromDim != THE_NETHER || toDim != OVERWORLD))) {
+                        BlockPos fromPortal = org.leavesmc.leaves.util.ReturnPortalManager.findPortalAt(this, fromDim, lastPos);
+                        BlockPos toPos = this.blockPosition();
+                        if (fromPortal != null) {
+                            org.leavesmc.leaves.util.ReturnPortalManager.storeReturnPortal(this, toDim, toPos, fromPortal);
+                        }
+                    }
+                }
+                // Leaves end - nether portal fix
                 // Paper start - Reset shield blocking on dimension change
                 if (this.isBlocking()) {
                     this.stopUsingItem();
diff --git a/net/minecraft/server/players/PlayerList.java b/net/minecraft/server/players/PlayerList.java
index 73f8562658d30ba17d5ecf2c778622e5e75ae135..cf3c9f2a19377f2d446f6220180f63557ef8a901 100644
--- a/net/minecraft/server/players/PlayerList.java
+++ b/net/minecraft/server/players/PlayerList.java
@@ -700,6 +700,20 @@ public abstract class PlayerList {
         // It's possible for respawn to be in a diff dimension
         if (fromLevel != level) {
             new org.bukkit.event.player.PlayerChangedWorldEvent(serverPlayer.getBukkitEntity(), fromLevel.getWorld()).callEvent();
+            // Leaves start - nether portal fix
+            if (org.leavesmc.leaves.LeavesConfig.modify.netherPortalFix) {
+                final ResourceKey<Level> fromDim = player.level().dimension();
+                final ResourceKey<Level> toDim = serverPlayer.level().dimension();
+                final ResourceKey<Level> OVERWORLD = Level.OVERWORLD;
+                final ResourceKey<Level> THE_NETHER = Level.NETHER;
+                if (!((fromDim != OVERWORLD || toDim != THE_NETHER) && (fromDim != THE_NETHER || toDim != OVERWORLD))) {
+                    BlockPos fromPortal = org.leavesmc.leaves.util.ReturnPortalManager.findPortalAt(serverPlayer, fromDim, serverPlayer.lastPos);
+                    if (fromPortal != null) {
+                        org.leavesmc.leaves.util.ReturnPortalManager.storeReturnPortal(serverPlayer, toDim, serverPlayer.blockPosition(), fromPortal);
+                    }
+                }
+            }
+            // Leaves end - nether portal fix
             serverPlayer.triggerDimensionChangeTriggers(level);
         }
 
diff --git a/net/minecraft/world/entity/LivingEntity.java b/net/minecraft/world/entity/LivingEntity.java
index ce4c8e14d3d7b5837dcce006fa67722f3f430fa4..759c320fc331704efe5df10d3f1f33aa87262290 100644
--- a/net/minecraft/world/entity/LivingEntity.java
+++ b/net/minecraft/world/entity/LivingEntity.java
@@ -259,7 +259,7 @@ public abstract class LivingEntity extends Entity implements Attackable, Waypoin
     protected ItemStack useItem = ItemStack.EMPTY;
     public int useItemRemaining;
     protected int fallFlyTicks;
-    private BlockPos lastPos;
+    public BlockPos lastPos; // Leaves - private -> public
     private Optional<BlockPos> lastClimbablePos = Optional.empty();
     @Nullable
     private DamageSource lastDamageSource;
diff --git a/net/minecraft/world/level/block/NetherPortalBlock.java b/net/minecraft/world/level/block/NetherPortalBlock.java
index d3f0a61c0c91d3a6a1dc4e59d57743ba89a9c19a..3d006562b2ba6f9a2059a8b534fbee3288067f78 100644
--- a/net/minecraft/world/level/block/NetherPortalBlock.java
+++ b/net/minecraft/world/level/block/NetherPortalBlock.java
@@ -179,7 +179,18 @@ public class NetherPortalBlock extends Block implements Portal {
 
     @Nullable
     private TeleportTransition getExitPortal(ServerLevel level, Entity entity, BlockPos pos, BlockPos exitPos, WorldBorder worldBorder, org.bukkit.craftbukkit.event.PortalEventResult result) { // CraftBukkit
-        Optional<BlockPos> optional = level.getPortalForcer().findClosestPortalPosition(exitPos, worldBorder, result.searchRadius()); // CraftBukkit
+        // Leaves start - fix return portal
+        Optional<BlockPos> optional = Optional.empty();
+        if (org.leavesmc.leaves.LeavesConfig.modify.netherPortalFix && entity instanceof net.minecraft.server.level.ServerPlayer player) {
+            org.leavesmc.leaves.util.ReturnPortalManager.ReturnPortal portal = org.leavesmc.leaves.util.ReturnPortalManager.findReturnPortal(player, entity.level().dimension(), entity.blockPosition());
+            if (portal != null && level.getBlockState(portal.pos()).is(Blocks.NETHER_PORTAL)) {
+                optional = Optional.of(portal.pos());
+            }
+        }
+        if (optional.isEmpty()) {
+            optional = level.getPortalForcer().findClosestPortalPosition(exitPos, worldBorder, result.searchRadius()); // CraftBukkit
+        }
+        // Leaves end - fix return portal
         BlockUtil.FoundRectangle largestRectangleAround;
         TeleportTransition.PostTeleportTransition postTeleportTransition;
         if (optional.isPresent()) {
