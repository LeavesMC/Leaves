From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: violetc <58360096+s-yh-china@users.noreply.github.com>
Date: Tue, 4 Feb 2025 19:45:19 +0800
Subject: [PATCH] Replay Mod API

This patch is Powered by ReplayMod(https://github.com/ReplayMod)

diff --git a/net/minecraft/commands/CommandSourceStack.java b/net/minecraft/commands/CommandSourceStack.java
index 566304106fd4f1c677a56e7c66282d1570e7b974..539cc641d894cc74051e01da7acc5a62b84ffb7c 100644
--- a/net/minecraft/commands/CommandSourceStack.java
+++ b/net/minecraft/commands/CommandSourceStack.java
@@ -562,7 +562,7 @@ public class CommandSourceStack implements ExecutionCommandSource<CommandSourceS
 
     @Override
     public Collection<String> getOnlinePlayerNames() {
-        return this.entity instanceof ServerPlayer sourcePlayer && !sourcePlayer.getBukkitEntity().hasPermission("paper.bypass-visibility.tab-completion") ? this.getServer().getPlayerList().getPlayers().stream().filter(serverPlayer -> sourcePlayer.getBukkitEntity().canSee(serverPlayer.getBukkitEntity())).map(serverPlayer -> serverPlayer.getGameProfile().name()).toList() : Lists.newArrayList(this.server.getPlayerNames()); // Paper - Make CommandSourceStack respect hidden players
+        return this.entity instanceof ServerPlayer sourcePlayer && !(sourcePlayer instanceof org.leavesmc.leaves.replay.ServerPhotographer) && !sourcePlayer.getBukkitEntity().hasPermission("paper.bypass-visibility.tab-completion") ? this.getServer().getPlayerList().getPlayers().stream().filter(serverPlayer -> sourcePlayer.getBukkitEntity().canSee(serverPlayer.getBukkitEntity())).map(serverPlayer -> serverPlayer.getGameProfile().name()).toList() : Lists.newArrayList(this.server.getPlayerNames()); // Paper - Make CommandSourceStack respect hidden players // Leaves - only real player
     }
 
     @Override
diff --git a/net/minecraft/commands/arguments/selector/EntitySelector.java b/net/minecraft/commands/arguments/selector/EntitySelector.java
index af71e0e1eb1c93745f3e4954ecc8fbd2ad4808a3..f3829564681faff3ae8971ed90b947b4a082a636 100644
--- a/net/minecraft/commands/arguments/selector/EntitySelector.java
+++ b/net/minecraft/commands/arguments/selector/EntitySelector.java
@@ -126,11 +126,12 @@ public class EntitySelector {
             return this.findPlayers(source);
         } else if (this.playerName != null) {
             ServerPlayer playerByName = source.getServer().getPlayerList().getPlayerByName(this.playerName);
+            playerByName = playerByName instanceof org.leavesmc.leaves.replay.ServerPhotographer ? null : playerByName; // Leaves - skip photographer
             return playerByName == null ? List.of() : List.of(playerByName);
         } else if (this.entityUUID != null) {
             for (ServerLevel serverLevel : source.getServer().getAllLevels()) {
                 Entity entity = serverLevel.getEntity(this.entityUUID);
-                if (entity != null) {
+                if (entity != null && !(entity instanceof org.leavesmc.leaves.replay.ServerPhotographer)) {
                     if (entity.getType().isEnabled(source.enabledFeatures())) {
                         return List.of(entity);
                     }
@@ -144,7 +145,7 @@ public class EntitySelector {
             AABB absoluteAabb = this.getAbsoluteAabb(vec3);
             if (this.currentEntity) {
                 Predicate<Entity> predicate = this.getPredicate(vec3, absoluteAabb, null);
-                return source.getEntity() != null && predicate.test(source.getEntity()) ? List.of(source.getEntity()) : List.of();
+                return source.getEntity() != null && !(source.getEntity() instanceof org.leavesmc.leaves.replay.ServerPhotographer) && predicate.test(source.getEntity()) ? List.of(source.getEntity()) : List.of(); // Leaves - skip photographer
             } else {
                 Predicate<Entity> predicate = this.getPredicate(vec3, absoluteAabb, source.enabledFeatures());
                 List<Entity> list = new ObjectArrayList<>();
@@ -155,6 +156,7 @@ public class EntitySelector {
                         this.addEntities(list, serverLevel1, absoluteAabb, predicate);
                     }
                 }
+                list.removeIf(entity -> entity instanceof org.leavesmc.leaves.replay.ServerPhotographer); // Leaves - skip photographer
 
                 return this.sortAndLimit(vec3, list);
             }
@@ -190,9 +192,11 @@ public class EntitySelector {
         this.checkPermissions(source);
         if (this.playerName != null) {
             ServerPlayer playerByName = source.getServer().getPlayerList().getPlayerByName(this.playerName);
+            playerByName = playerByName instanceof org.leavesmc.leaves.replay.ServerPhotographer ? null : playerByName; // Leaves - skip photographer
             return playerByName == null ? List.of() : List.of(playerByName);
         } else if (this.entityUUID != null) {
             ServerPlayer playerByName = source.getServer().getPlayerList().getPlayer(this.entityUUID);
+            playerByName = playerByName instanceof org.leavesmc.leaves.replay.ServerPhotographer ? null : playerByName; // Leaves - skip photographer
             return playerByName == null ? List.of() : List.of(playerByName);
         } else {
             Vec3 vec3 = this.position.apply(source.getPosition());
@@ -204,11 +208,11 @@ public class EntitySelector {
                 int resultLimit = this.getResultLimit();
                 List<ServerPlayer> players;
                 if (this.isWorldLimited()) {
-                    players = source.getLevel().getPlayers(predicate, resultLimit);
+                    players = source.getLevel().getPlayers((player -> !(player instanceof org.leavesmc.leaves.replay.ServerPhotographer) && predicate.test(player)), resultLimit); // Leaves - skip photographer
                 } else {
                     players = new ObjectArrayList<>();
 
-                    for (ServerPlayer serverPlayer1 : source.getServer().getPlayerList().getPlayers()) {
+                    for (ServerPlayer serverPlayer1 : source.getServer().getPlayerList().realPlayers) { // Leaves - only real players
                         if (predicate.test(serverPlayer1)) {
                             players.add(serverPlayer1);
                             if (players.size() >= resultLimit) {
diff --git a/net/minecraft/server/MinecraftServer.java b/net/minecraft/server/MinecraftServer.java
index 096da619b8515a4599e432adbce4aff98f246434..322c1d547a3c78dad49cc3b62c97e2d21b83f7be 100644
--- a/net/minecraft/server/MinecraftServer.java
+++ b/net/minecraft/server/MinecraftServer.java
@@ -1738,7 +1738,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
     }
 
     private ServerStatus.Players buildPlayerStatus() {
-        List<ServerPlayer> players = this.playerList.getPlayers();
+        List<ServerPlayer> players = this.playerList.realPlayers; // Leaves - only real player
         int maxPlayers = this.getMaxPlayers();
         if (this.hidesOnlinePlayers()) {
             return new ServerStatus.Players(maxPlayers, players.size(), List.of());
@@ -1965,7 +1965,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
 
     @Override
     public int getPlayerCount() {
-        return this.playerList.getPlayerCount();
+        return this.playerList.realPlayers.size(); // Leaves - only real player
     }
 
     public String[] getPlayerNames() {
@@ -2169,7 +2169,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
         } else {
             int i = 0;
 
-            for (ServerPlayer serverPlayer : this.getPlayerList().getPlayers()) {
+            for (ServerPlayer serverPlayer : this.getPlayerList().realPlayers) { // Leaves - only real player
                 // Paper start - Expand PlayerGameModeChangeEvent
                 org.bukkit.event.player.PlayerGameModeChangeEvent event = serverPlayer.setGameMode(gameMode, org.bukkit.event.player.PlayerGameModeChangeEvent.Cause.DEFAULT_GAMEMODE, null);
                 if (event == null || event.isCancelled()) {
@@ -2333,7 +2333,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
                     if (Thread.currentThread() != this.serverThread) return; // Paper
                     // Paper start - we don't need to save everything, just advancements
                     // this.getPlayerList().saveAll();
-                    for (final ServerPlayer player : this.getPlayerList().getPlayers()) {
+                    for (final ServerPlayer player : this.getPlayerList().realPlayers) { // Leaves - only real players
                         player.getAdvancements().save();
                     }
                     // Paper end - we don't need to save everything, just advancements
@@ -2471,7 +2471,7 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
             PlayerList playerList = this.getPlayerList();
             UserWhiteList whiteList = playerList.getWhiteList();
 
-            for (ServerPlayer serverPlayer : Lists.newArrayList(playerList.getPlayers())) {
+            for (ServerPlayer serverPlayer : Lists.newArrayList(playerList.realPlayers)) { // Leaves - only real player
                 if (!whiteList.isWhiteListed(serverPlayer.nameAndId()) && !this.getPlayerList().isOp(serverPlayer.nameAndId())) { // Paper - Fix kicking ops when whitelist is reloaded (MC-171420)
                     serverPlayer.connection.disconnect(net.kyori.adventure.text.Component.text(org.spigotmc.SpigotConfig.whitelistMessage), org.bukkit.event.player.PlayerKickEvent.Cause.WHITELIST); // Paper - use configurable message & kick event cause
                 }
diff --git a/net/minecraft/server/PlayerAdvancements.java b/net/minecraft/server/PlayerAdvancements.java
index 80d7227cb889fd3ef5d8563a00af5f3219b4496a..9feb4cd646534dd1b8b05e0bd9353131d03da7b7 100644
--- a/net/minecraft/server/PlayerAdvancements.java
+++ b/net/minecraft/server/PlayerAdvancements.java
@@ -172,7 +172,7 @@ public class PlayerAdvancements {
         }
         // Leaves end - spectator don't get advancement
         // Leaves start - bot can't get advancement
-        if (player instanceof org.leavesmc.leaves.bot.ServerBot) {
+        if (player instanceof org.leavesmc.leaves.bot.ServerBot || player instanceof org.leavesmc.leaves.replay.ServerPhotographer) { // Leaves - and photographer
             return false;
         }
         // Leaves end - bot can't get advancement
diff --git a/net/minecraft/server/ServerScoreboard.java b/net/minecraft/server/ServerScoreboard.java
index 2f4b9ea0f35f10d36b4c88f51227329e3f135841..4187f19acf042a402167e4385902268121b09444 100644
--- a/net/minecraft/server/ServerScoreboard.java
+++ b/net/minecraft/server/ServerScoreboard.java
@@ -251,7 +251,7 @@ public class ServerScoreboard extends Scoreboard {
     public void startTrackingObjective(Objective objective) {
         List<Packet<?>> startTrackingPackets = this.getStartTrackingPackets(objective);
 
-        for (ServerPlayer serverPlayer : this.server.getPlayerList().getPlayers()) {
+        for (ServerPlayer serverPlayer : this.server.getPlayerList().realPlayers) { // Leaves - only real players
             if (serverPlayer.getBukkitEntity().getScoreboard().getHandle() != this) continue; // CraftBukkit - Only players on this board
             for (Packet<?> packet : startTrackingPackets) {
                 serverPlayer.connection.send(packet);
@@ -277,7 +277,7 @@ public class ServerScoreboard extends Scoreboard {
     public void stopTrackingObjective(Objective objective) {
         List<Packet<?>> stopTrackingPackets = this.getStopTrackingPackets(objective);
 
-        for (ServerPlayer serverPlayer : this.server.getPlayerList().getPlayers()) {
+        for (ServerPlayer serverPlayer : this.server.getPlayerList().realPlayers) { // Leaves - only real players
             if (serverPlayer.getBukkitEntity().getScoreboard().getHandle() != this) continue; // CraftBukkit - Only players on this board
             for (Packet<?> packet : stopTrackingPackets) {
                 serverPlayer.connection.send(packet);
diff --git a/net/minecraft/server/commands/ListPlayersCommand.java b/net/minecraft/server/commands/ListPlayersCommand.java
index e7c778a7f292fd0749cbd5e6586ad1b93ac7f29e..024b56405bb58801b17a6adad7fec7a461d12a5c 100644
--- a/net/minecraft/server/commands/ListPlayersCommand.java
+++ b/net/minecraft/server/commands/ListPlayersCommand.java
@@ -33,7 +33,7 @@ public class ListPlayersCommand {
     private static int format(CommandSourceStack source, Function<ServerPlayer, Component> nameExtractor) {
         PlayerList playerList = source.getServer().getPlayerList();
         // CraftBukkit start
-        List<ServerPlayer> playersTemp = playerList.getPlayers();
+        List<ServerPlayer> playersTemp = playerList.realPlayers;
         if (source.getBukkitSender() instanceof org.bukkit.entity.Player) {
             org.bukkit.entity.Player sender = (org.bukkit.entity.Player) source.getBukkitSender();
             playersTemp = playersTemp.stream().filter((ep) -> sender.canSee(ep.getBukkitEntity())).collect(java.util.stream.Collectors.toList());
diff --git a/net/minecraft/server/commands/OpCommand.java b/net/minecraft/server/commands/OpCommand.java
index 590891d70a71ab30ceae3a3cf1923745e7c20b26..0ede1e5c73a0071e854de70f81ae1fc6a1d6dc59 100644
--- a/net/minecraft/server/commands/OpCommand.java
+++ b/net/minecraft/server/commands/OpCommand.java
@@ -25,7 +25,7 @@ public class OpCommand {
                             (commandContext, suggestionsBuilder) -> {
                                 PlayerList playerList = commandContext.getSource().getServer().getPlayerList();
                                 return SharedSuggestionProvider.suggest(
-                                    playerList.getPlayers()
+                                    playerList.realPlayers // Leaves - only real player
                                         .stream()
                                         .filter(serverPlayer -> !playerList.isOp(serverPlayer.nameAndId()))
                                         .map(serverPlayer -> serverPlayer.getGameProfile().name()),
diff --git a/net/minecraft/server/commands/ParticleCommand.java b/net/minecraft/server/commands/ParticleCommand.java
index b5cb0fd45c1e33f40ff38e86772c9e6cc06c10a0..e9ac6ee47fd9c3d73e55a3467bb1c53f931609d0 100644
--- a/net/minecraft/server/commands/ParticleCommand.java
+++ b/net/minecraft/server/commands/ParticleCommand.java
@@ -36,7 +36,7 @@ public class ParticleCommand {
                                 0.0F,
                                 0,
                                 false,
-                                commandContext.getSource().getServer().getPlayerList().getPlayers()
+                                commandContext.getSource().getServer().getPlayerList().realPlayers // Leaves - only real player
                             )
                         )
                         .then(
@@ -50,7 +50,7 @@ public class ParticleCommand {
                                         0.0F,
                                         0,
                                         false,
-                                        context1.getSource().getServer().getPlayerList().getPlayers()
+                                        context1.getSource().getServer().getPlayerList().realPlayers // Leaves - only real player
                                     )
                                 )
                                 .then(
@@ -68,7 +68,7 @@ public class ParticleCommand {
                                                                 FloatArgumentType.getFloat(context1, "speed"),
                                                                 IntegerArgumentType.getInteger(context1, "count"),
                                                                 false,
-                                                                context1.getSource().getServer().getPlayerList().getPlayers()
+                                                                context1.getSource().getServer().getPlayerList().realPlayers // Leaves - only real player
                                                             )
                                                         )
                                                         .then(
@@ -82,7 +82,7 @@ public class ParticleCommand {
                                                                         FloatArgumentType.getFloat(context1, "speed"),
                                                                         IntegerArgumentType.getInteger(context1, "count"),
                                                                         true,
-                                                                        context1.getSource().getServer().getPlayerList().getPlayers()
+                                                                        context1.getSource().getServer().getPlayerList().realPlayers // Leaves - only real player
                                                                     )
                                                                 )
                                                                 .then(
@@ -112,7 +112,7 @@ public class ParticleCommand {
                                                                         FloatArgumentType.getFloat(context1, "speed"),
                                                                         IntegerArgumentType.getInteger(context1, "count"),
                                                                         false,
-                                                                        context1.getSource().getServer().getPlayerList().getPlayers()
+                                                                        context1.getSource().getServer().getPlayerList().realPlayers // Leaves - only real player
                                                                     )
                                                                 )
                                                                 .then(
diff --git a/net/minecraft/server/commands/TeamMsgCommand.java b/net/minecraft/server/commands/TeamMsgCommand.java
index 0ae4d68dfe42004839a0c5ad457de592f6b4af8b..1d1e396e4b29f33669872fb39e3a7f1d474a49f7 100644
--- a/net/minecraft/server/commands/TeamMsgCommand.java
+++ b/net/minecraft/server/commands/TeamMsgCommand.java
@@ -40,7 +40,7 @@ public class TeamMsgCommand {
                                 } else {
                                     List<ServerPlayer> list = commandSourceStack.getServer()
                                         .getPlayerList()
-                                        .getPlayers()
+                                        .realPlayers // Leaves - only real players
                                         .stream()
                                         .filter(player -> player == entityOrException || player.getTeam() == team)
                                         .toList();
diff --git a/net/minecraft/server/commands/WhitelistCommand.java b/net/minecraft/server/commands/WhitelistCommand.java
index 305273583b3d2ad233c6cd67883baad15fe572eb..ce2939eac9c66e0c6eaac1570c4da19d908662ad 100644
--- a/net/minecraft/server/commands/WhitelistCommand.java
+++ b/net/minecraft/server/commands/WhitelistCommand.java
@@ -44,7 +44,7 @@ public class WhitelistCommand {
                                     (commandContext, suggestionsBuilder) -> {
                                         PlayerList playerList = commandContext.getSource().getServer().getPlayerList();
                                         return SharedSuggestionProvider.suggest(
-                                            playerList.getPlayers()
+                                            playerList.realPlayers // Leaves - only real player
                                                 .stream()
                                                 .map(Player::nameAndId)
                                                 .filter(nameAndId -> !playerList.getWhiteList().isWhiteListed(nameAndId))
diff --git a/net/minecraft/server/gui/PlayerListComponent.java b/net/minecraft/server/gui/PlayerListComponent.java
index 5a8cd3e6b448a4472092690cf589bca10b142126..8f22d5faf89006153b1fff4ff0b622f8de9fb588 100644
--- a/net/minecraft/server/gui/PlayerListComponent.java
+++ b/net/minecraft/server/gui/PlayerListComponent.java
@@ -17,8 +17,8 @@ public class PlayerListComponent extends JList<String> {
         if (this.tickCount++ % 20 == 0) {
             Vector<String> list = new Vector<>();
 
-            for (int i = 0; i < this.server.getPlayerList().getPlayers().size(); i++) {
-                list.add(this.server.getPlayerList().getPlayers().get(i).getGameProfile().name());
+            for (int i = 0; i < this.server.getPlayerList().realPlayers.size(); i++) { // Leaves - only real players
+                list.add(this.server.getPlayerList().realPlayers.get(i).getGameProfile().name()); // Leaves - only real players
             }
 
             this.setListData(list);
diff --git a/net/minecraft/server/level/ServerLevel.java b/net/minecraft/server/level/ServerLevel.java
index b06e7dd6f1ce735d4ea9b4c3f75c004adc296487..499714800b2160cf163fc7a37e287f655a9d80ee 100644
--- a/net/minecraft/server/level/ServerLevel.java
+++ b/net/minecraft/server/level/ServerLevel.java
@@ -2816,7 +2816,7 @@ public class ServerLevel extends Level implements ServerEntityGetter, WorldGenLe
             if (entity instanceof ServerPlayer serverPlayer) {
                 ServerLevel.this.players.add(serverPlayer);
                 // Leaves start - skip
-                if (!(serverPlayer instanceof org.leavesmc.leaves.bot.ServerBot)) {
+                if (!(serverPlayer instanceof org.leavesmc.leaves.bot.ServerBot) && !(serverPlayer instanceof org.leavesmc.leaves.replay.ServerPhotographer)) { // and photographer
                     ServerLevel.this.realPlayers.add(serverPlayer);
                 }
                 // Leaves end - skip
@@ -2899,7 +2899,7 @@ public class ServerLevel extends Level implements ServerEntityGetter, WorldGenLe
             if (entity instanceof ServerPlayer serverPlayer) {
                 ServerLevel.this.players.remove(serverPlayer);
                 // Leaves start - skip
-                if (!(serverPlayer instanceof org.leavesmc.leaves.bot.ServerBot)) {
+                if (!(serverPlayer instanceof org.leavesmc.leaves.bot.ServerBot) && !(serverPlayer instanceof org.leavesmc.leaves.replay.ServerPhotographer)) { // and photographer
                     ServerLevel.this.realPlayers.remove(serverPlayer);
                 }
                 // Leaves end - skip
diff --git a/net/minecraft/server/players/PlayerList.java b/net/minecraft/server/players/PlayerList.java
index fce0114134eb1ffee558f6ce072e793eafbd6779..7b5b9d0a5a99108ba5853891918565a22aaa8efd 100644
--- a/net/minecraft/server/players/PlayerList.java
+++ b/net/minecraft/server/players/PlayerList.java
@@ -130,6 +130,7 @@ public abstract class PlayerList {
     private int simulationDistance;
     private boolean allowCommandsForAllPlayers;
     private int sendAllPlayerInfoIn;
+    public final List<ServerPlayer> realPlayers = new java.util.concurrent.CopyOnWriteArrayList(); // Leaves - replay api
 
     // CraftBukkit start
     private org.bukkit.craftbukkit.CraftServer cserver;
@@ -153,6 +154,124 @@ public abstract class PlayerList {
 
     abstract public void loadAndSaveFiles(); // Paper - fix converting txt to json file; moved from DedicatedPlayerList constructor
 
+    // Leaves start - replay mod api
+    public void placeNewPhotographer(Connection connection, org.leavesmc.leaves.replay.ServerPhotographer player, ServerLevel worldserver) {
+        player.isRealPlayer = true; // Paper
+        player.loginTime = System.currentTimeMillis(); // Paper
+
+        ServerLevel worldserver1 = worldserver;
+
+        player.setServerLevel(worldserver1);
+        player.spawnIn(worldserver1);
+        player.gameMode.setLevel(player.level());
+
+        LevelData worlddata = worldserver1.getLevelData();
+
+        ServerGamePacketListenerImpl playerconnection = new ServerGamePacketListenerImpl(this.server, connection, player, CommonListenerCookie.createInitial(player.gameProfile, false));
+        GameRules gamerules = worldserver1.getGameRules();
+        boolean flag = gamerules.get(net.minecraft.world.level.gamerules.GameRules.IMMEDIATE_RESPAWN);
+        boolean flag1 = gamerules.get(net.minecraft.world.level.gamerules.GameRules.REDUCED_DEBUG_INFO);
+        boolean flag2 = gamerules.get(net.minecraft.world.level.gamerules.GameRules.LIMITED_CRAFTING);
+
+        playerconnection.send(new ClientboundLoginPacket(player.getId(), worlddata.isHardcore(), this.server.levelKeys(), this.getMaxPlayers(), worldserver1.getWorld().getSendViewDistance(), worldserver1.getWorld().getSimulationDistance(), flag1, !flag, flag2, player.createCommonSpawnInfo(worldserver1), this.server.enforceSecureProfile())); // Paper - replace old player chunk management
+        player.getBukkitEntity().sendSupportedChannels(); // CraftBukkit
+        playerconnection.send(new ClientboundChangeDifficultyPacket(worlddata.getDifficulty(), worlddata.isDifficultyLocked()));
+        playerconnection.send(new ClientboundPlayerAbilitiesPacket(player.getAbilities()));
+        playerconnection.send(new ClientboundSetHeldSlotPacket(player.getInventory().getSelectedSlot()));
+        RecipeManager craftingmanager = this.server.getRecipeManager();
+        playerconnection.send(new ClientboundUpdateRecipesPacket(craftingmanager.getSynchronizedItemProperties(), craftingmanager.getSynchronizedStonecutterRecipes()));
+
+        this.sendPlayerPermissionLevel(player);
+        player.getStats().markAllDirty();
+        player.getRecipeBook().sendInitialRecipeBook(player);
+        this.updateEntireScoreboard(worldserver1.getScoreboard(), player);
+        this.server.invalidateStatus();
+
+        playerconnection.teleport(player.getX(), player.getY(), player.getZ(), player.getYRot(), player.getXRot());
+        ServerStatus serverping = this.server.getStatus();
+
+        if (serverping != null) {
+            player.sendServerStatus(serverping);
+        }
+
+        this.players.add(player);
+        this.playersByName.put(player.getScoreboardName().toLowerCase(java.util.Locale.ROOT), player); // Spigot
+        this.playersByUUID.put(player.getUUID(), player);
+
+        player.suppressTrackerForLogin = true;
+        worldserver1.addNewPlayer(player);
+        this.server.getCustomBossEvents().onPlayerConnect(player);
+        org.bukkit.craftbukkit.entity.CraftPlayer bukkitPlayer = player.getBukkitEntity();
+
+        player.containerMenu.transferTo(player.containerMenu, bukkitPlayer);
+        if (!player.connection.isAcceptingMessages()) {
+            return;
+        }
+
+        // org.leavesmc.leaves.protocol.core.LeavesProtocolManager.handlePlayerJoin(player); // Leaves - protocol
+
+        // Leaves start - bot support
+        if (org.leavesmc.leaves.LeavesConfig.modify.fakeplayer.enable) {
+            org.leavesmc.leaves.bot.ServerBot bot = this.server.getBotList().getBotByName(player.getScoreboardName());
+            if (bot != null) {
+                this.server.getBotList().removeBot(bot, org.leavesmc.leaves.event.bot.BotRemoveEvent.RemoveReason.INTERNAL, player.getBukkitEntity(), false, false);
+            }
+            this.server.getBotList().bots.forEach(bot1 -> {
+                bot1.sendPlayerInfo(player);
+                bot1.sendFakeDataIfNeed(player, true);
+            }); // Leaves - render bot
+        }
+        // Leaves end - bot support
+
+        final List<ServerPlayer> onlinePlayers = Lists.newArrayListWithExpectedSize(this.players.size() - 1);
+        for (int i = 0; i < this.players.size(); ++i) {
+            ServerPlayer entityplayer1 = this.players.get(i);
+
+            if (entityplayer1 == player || !bukkitPlayer.canSee(entityplayer1.getBukkitEntity())) {
+                continue;
+            }
+
+            // Leaves start - skip photographer
+            if (entityplayer1 instanceof org.leavesmc.leaves.replay.ServerPhotographer) {
+                continue;
+            }
+            // Leaves end - skip photographer
+
+            onlinePlayers.add(entityplayer1);
+        }
+        if (!onlinePlayers.isEmpty()) {
+            player.connection.send(ClientboundPlayerInfoUpdatePacket.createPlayerInitializing(onlinePlayers, player));
+        }
+
+        player.sentListPacket = true;
+        player.suppressTrackerForLogin = false;
+        ((ServerLevel)player.level()).getChunkSource().chunkMap.addEntity(player);
+
+        this.sendLevelInfo(player, worldserver1);
+
+        if (player.level() == worldserver1 && !worldserver1.players().contains(player)) {
+            worldserver1.addNewPlayer(player);
+            this.server.getCustomBossEvents().onPlayerConnect(player);
+        }
+
+        worldserver1 = player.level();
+        java.util.Iterator<net.minecraft.world.effect.MobEffectInstance> iterator = player.getActiveEffects().iterator();
+        while (iterator.hasNext()) {
+            MobEffectInstance mobeffect = iterator.next();
+            playerconnection.send(new ClientboundUpdateMobEffectPacket(player.getId(), mobeffect, false));
+        }
+
+        if (player.isDeadOrDying()) {
+            net.minecraft.core.Holder<net.minecraft.world.level.biome.Biome> plains = worldserver1.registryAccess().lookupOrThrow(net.minecraft.core.registries.Registries.BIOME)
+                    .getOrThrow(net.minecraft.world.level.biome.Biomes.PLAINS);
+            player.connection.send(new net.minecraft.network.protocol.game.ClientboundLevelChunkWithLightPacket(
+                    new net.minecraft.world.level.chunk.EmptyLevelChunk(worldserver1, player.chunkPosition(), plains),
+                    worldserver1.getLightEngine(), null, null, false)
+            );
+        }
+    }
+    // Leaves end - replay mod api
+
     public void placeNewPlayer(Connection connection, ServerPlayer player, CommonListenerCookie cookie) {
         player.isRealPlayer = true; // Paper
         player.loginTime = System.currentTimeMillis(); // Paper - Replace OfflinePlayer#getLastPlayed
@@ -221,6 +340,7 @@ public abstract class PlayerList {
 
         // player.connection.send(ClientboundPlayerInfoUpdatePacket.createPlayerInitializing(this.players)); // CraftBukkit - replaced with loop below
         this.players.add(player);
+        this.realPlayers.add(player); // Leaves - replay api
         this.playersByName.put(player.getScoreboardName().toLowerCase(java.util.Locale.ROOT), player); // Spigot
         this.playersByUUID.put(player.getUUID(), player);
         // this.broadcastAll(ClientboundPlayerInfoUpdatePacket.createPlayerInitializing(List.of(player))); // CraftBukkit - replaced with loop below
@@ -426,6 +546,7 @@ public abstract class PlayerList {
     }
 
     protected void save(ServerPlayer player) {
+        if (player instanceof org.leavesmc.leaves.replay.ServerPhotographer) return; // Leaves - skip photographer
         if (!player.getBukkitEntity().isPersistent()) return; // CraftBukkit
         player.lastSave = MinecraftServer.currentTick; // Paper - Incremental chunk and player saving
         this.playerIo.save(player);
@@ -440,6 +561,43 @@ public abstract class PlayerList {
         }
     }
 
+    // Leaves start - replay mod api
+    public void removePhotographer(org.leavesmc.leaves.replay.ServerPhotographer entityplayer) {
+        ServerLevel worldserver = entityplayer.level();
+
+        entityplayer.awardStat(Stats.LEAVE_GAME);
+
+        if (entityplayer.containerMenu != entityplayer.inventoryMenu) {
+            entityplayer.closeContainer(org.bukkit.event.inventory.InventoryCloseEvent.Reason.DISCONNECT);
+        }
+
+        if (server.isSameThread()) entityplayer.doTick();
+
+        if (this.collideRuleTeamName != null) {
+            final net.minecraft.world.scores.Scoreboard scoreBoard = this.server.getLevel(Level.OVERWORLD).getScoreboard();
+            final PlayerTeam team = scoreBoard.getPlayersTeam(this.collideRuleTeamName);
+            if (entityplayer.getTeam() == team && team != null) {
+                scoreBoard.removePlayerFromTeam(entityplayer.getScoreboardName(), team);
+            }
+        }
+
+        worldserver.removePlayerImmediately(entityplayer, Entity.RemovalReason.UNLOADED_WITH_PLAYER);
+        entityplayer.retireScheduler();
+        entityplayer.getAdvancements().stopListening();
+        this.players.remove(entityplayer);
+        this.playersByName.remove(entityplayer.getScoreboardName().toLowerCase(java.util.Locale.ROOT));
+        this.server.getCustomBossEvents().onPlayerDisconnect(entityplayer);
+        UUID uuid = entityplayer.getUUID();
+        ServerPlayer entityplayer1 = this.playersByUUID.get(uuid);
+
+        if (entityplayer1 == entityplayer) {
+            this.playersByUUID.remove(uuid);
+        }
+
+        this.cserver.getScoreboardManager().removePlayer(entityplayer.getBukkitEntity());
+    }
+    // Leaves stop - replay mod api
+
     public net.kyori.adventure.text.@Nullable Component remove(ServerPlayer player) { // CraftBukkit - return string // Paper - return Component
         // Paper start - Fix kick event leave message not being sent
         return this.remove(player, net.kyori.adventure.text.Component.translatable("multiplayer.player.left", net.kyori.adventure.text.format.NamedTextColor.YELLOW, io.papermc.paper.configuration.GlobalConfiguration.get().messages.useDisplayNameInQuitMessage ? player.getBukkitEntity().displayName() : io.papermc.paper.adventure.PaperAdventure.asAdventure(player.getDisplayName())));
@@ -513,6 +671,7 @@ public abstract class PlayerList {
         player.retireScheduler(); // Paper - Folia schedulers
         player.getAdvancements().stopListening();
         this.players.remove(player);
+        this.realPlayers.remove(player); // Leaves - replay api
         this.playersByName.remove(player.getScoreboardName().toLowerCase(java.util.Locale.ROOT)); // Spigot
         this.server.getCustomBossEvents().onPlayerDisconnect(player);
         UUID uuid = player.getUUID();
@@ -841,14 +1000,14 @@ public abstract class PlayerList {
     }
 
     public String[] getPlayerNamesArray() {
-        String[] strings = new String[this.players.size() + this.server.getBotList().bots.size()]; // Leaves - fakeplayer support
+        String[] strings = new String[this.realPlayers.size() + this.server.getBotList().bots.size()]; // Leaves - fakeplayer support, and skip photographer
 
-        for (int i = 0; i < this.players.size(); i++) {
-            strings[i] = this.players.get(i).getGameProfile().name();
+        for (int i = 0; i < this.realPlayers.size(); i++) { // Leaves - only real players
+            strings[i] = this.realPlayers.get(i).getGameProfile().name(); // Leaves - only real players
         }
         // Leaves start - fakeplayer support
-        for (int i = this.players.size(); i < strings.length; ++i) {
-            strings[i] = this.server.getBotList().bots.get(i - this.players.size()).getGameProfile().getName();
+        for (int i = this.realPlayers.size(); i < strings.length; ++i) { // Leaves - only real players
+            strings[i] = this.server.getBotList().bots.get(i - this.realPlayers.size()).getGameProfile().name(); // Leaves - only real players
         }
         // Leaves end - fakeplayer support
 
@@ -915,7 +1074,7 @@ public abstract class PlayerList {
 
     // Paper start - whitelist verify event / login event
     public LoginResult canBypassFullServerLogin(final NameAndId nameAndId, final LoginResult currentResult) {
-        final boolean shouldKick = this.players.size() >= this.getMaxPlayers() && !this.canBypassPlayerLimit(nameAndId);
+        final boolean shouldKick = this.realPlayers.size() >= this.getMaxPlayers() && !this.canBypassPlayerLimit(nameAndId); // Leaves - only real player
         final io.papermc.paper.event.player.PlayerServerFullCheckEvent fullCheckEvent = new io.papermc.paper.event.player.PlayerServerFullCheckEvent(
             new com.destroystokyo.paper.profile.CraftPlayerProfile(nameAndId),
             io.papermc.paper.adventure.PaperAdventure.asAdventure(currentResult.message),
