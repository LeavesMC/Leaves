From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: violetc <58360096+s-yh-china@users.noreply.github.com>
Date: Mon, 4 Sep 2023 00:16:09 +0800
Subject: [PATCH] Wool Hopper Counter

This patch is Powered by fabric-carpet(https://github.com/gnembon/fabric-carpet)

diff --git a/src/main/java/net/minecraft/world/item/crafting/Ingredient.java b/src/main/java/net/minecraft/world/item/crafting/Ingredient.java
index e314f36951e9ac15c57137e24fce8c410373130a..dd232d9e86c5bf03cfb4597d3291a172d8c17741 100644
--- a/src/main/java/net/minecraft/world/item/crafting/Ingredient.java
+++ b/src/main/java/net/minecraft/world/item/crafting/Ingredient.java
@@ -35,7 +35,7 @@ public final class Ingredient implements Predicate<ItemStack> {
     }, (recipeitemstack) -> {
         return Arrays.asList(recipeitemstack.getItems());
     });
-    private final Ingredient.Value[] values;
+    public final Ingredient.Value[] values; // Leaves - private -> public
     @Nullable
     public ItemStack[] itemStacks;
     @Nullable
diff --git a/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
index 6461d2c98bdc914c090405ca42b2c88e267001a9..97979751641c1b4cc4e788bd819df0d90160ad89 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/HopperBlockEntity.java
@@ -433,6 +433,13 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
     // Paper end - Perf: Optimize Hoppers
 
     private static boolean ejectItems(Level world, BlockPos pos, HopperBlockEntity blockEntity) {
+        // Leaves start - hopper counter
+        if (top.leavesmc.leaves.util.HopperCounter.isEnabled()) {
+            if (woolHopperCounter(world, pos, blockEntity.getBlockState(), blockEntity.persistentDataContainer, blockEntity)) {
+                return true;
+            }
+        }
+        // Leaves end - hopper counter
         Container iinventory = HopperBlockEntity.getAttachedContainer(world, pos, blockEntity);
 
         if (iinventory == null) {
@@ -491,6 +498,23 @@ public class HopperBlockEntity extends RandomizableContainerBlockEntity implemen
         }
     }
 
+    // Leaves start - hopper counter
+    private static boolean woolHopperCounter(Level level, BlockPos blockPos, BlockState state, Container container, HopperBlockEntity hopper) {
+        net.minecraft.world.item.DyeColor woolColor = top.leavesmc.leaves.util.WoolUtils.getWoolColorAtPosition(level, blockPos.relative(state.getValue(HopperBlock.FACING)));
+        if (woolColor != null) {
+            for (int i = 0; i < container.getContainerSize(); ++i) {
+                if (!container.getItem(i).isEmpty()) {
+                    ItemStack itemstack = container.getItem(i);
+                    top.leavesmc.leaves.util.HopperCounter.getCounter(woolColor).add(level.getServer(), itemstack);
+                    container.setItem(i, ItemStack.EMPTY);
+                }
+            }
+            return true;
+        }
+        return false;
+    }
+    // Leaves end - hopper counter
+
     private static int[] getSlots(Container inventory, Direction side) {
         if (inventory instanceof WorldlyContainer iworldinventory) {
             return iworldinventory.getSlotsForFace(side);
diff --git a/src/main/java/top/leavesmc/leaves/command/LeavesCommand.java b/src/main/java/top/leavesmc/leaves/command/LeavesCommand.java
index 5efdb9b5138738da7cfc075ce0be531d2608577e..9fc807312bd61158f996abb8424ec0c0005d2d42 100644
--- a/src/main/java/top/leavesmc/leaves/command/LeavesCommand.java
+++ b/src/main/java/top/leavesmc/leaves/command/LeavesCommand.java
@@ -13,6 +13,7 @@ import org.bukkit.plugin.PluginManager;
 import org.checkerframework.checker.nullness.qual.Nullable;
 import org.jetbrains.annotations.NotNull;
 import top.leavesmc.leaves.command.subcommands.ConfigCommand;
+import top.leavesmc.leaves.command.subcommands.CounterCommand;
 import top.leavesmc.leaves.command.subcommands.PeacefulModeSwitchCommand;
 import top.leavesmc.leaves.command.subcommands.UpdateCommand;
 
@@ -37,6 +38,7 @@ public final class LeavesCommand extends Command {
         commands.put(Set.of("config"), new ConfigCommand());
         commands.put(Set.of("update"), new UpdateCommand());
         commands.put(Set.of("peaceful"), new PeacefulModeSwitchCommand());
+        commands.put(Set.of("counter"), new CounterCommand());
 
         return commands.entrySet().stream()
             .flatMap(entry -> entry.getKey().stream().map(s -> Map.entry(s, entry.getValue())))
